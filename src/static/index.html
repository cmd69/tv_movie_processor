<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TV Show and Movie Processor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <style>
        body {
            padding-top: 20px;
            background-color: #f8f9fa;
        }
        .file-browser {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            background-color: white;
        }
        .file-item {
            padding: 8px 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
        }
        .file-item:hover {
            background-color: #f8f9fa;
        }
        .file-item.selected {
            background-color: #e9ecef;
        }
        .file-item i {
            margin-right: 10px;
        }
        .breadcrumb {
            background-color: #f8f9fa;
            padding: 8px 15px;
            border-radius: 0.25rem;
            margin-bottom: 15px;
        }
        .selected-files {
            margin-top: 20px;
            padding: 10px;
            background-color: white;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
        }
        .selected-pair {
            padding: 8px;
            margin-bottom: 5px;
            background-color: #f8f9fa;
            border-radius: 0.25rem;
        }
        .progress {
            height: 25px;
        }
        .nav-tabs .nav-link {
            cursor: pointer;
        }
        .job-card {
            margin-bottom: 15px;
        }
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
        }
        .media-root-alert {
            margin-bottom: 20px;
        }
        .navbar {
            margin-bottom: 20px;
        }
        .job-result {
            margin-top: 10px;
            padding: 8px;
            border-radius: 0.25rem;
        }
        .job-result.success {
            background-color: #d4edda;
        }
        .job-result.failure {
            background-color: #f8d7da;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Navigation Bar -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary rounded">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">TV Movie Processor</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="nav-movie">Movie Mode</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="nav-tv">TV Show Mode</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="nav-jobs">Job History</a>
                        </li>
                    </ul>
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-link" href="/auth/logout">Logout</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
        
        <div id="toast-container"></div>
        
        <div id="media-root-status" class="alert alert-info media-root-alert">
            <strong>Media Root:</strong> <span id="media-root-path">/mnt/nfs/media</span>
            <span id="media-root-status-text" class="ms-2">(Checking status...)</span>
        </div>
        
        <div class="tab-content" id="processorTabsContent">
            <!-- Movie Mode Tab -->
            <div class="tab-pane fade" id="movie-content" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5>Original Version (VO) File</h5>
                            </div>
                            <div class="card-body">
                                <nav aria-label="breadcrumb" id="vo-breadcrumb">
                                    <ol class="breadcrumb">
                                        <li class="breadcrumb-item"><a href="#" data-path="/mnt/nfs/media">Media Root</a></li>
                                    </ol>
                                </nav>
                                <div class="file-browser" id="vo-browser"></div>
                                <div class="mt-3">
                                    <p>Selected: <span id="vo-selected-path" class="text-primary">None</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5>Spanish Version (ES) File</h5>
                            </div>
                            <div class="card-body">
                                <nav aria-label="breadcrumb" id="es-breadcrumb">
                                    <ol class="breadcrumb">
                                        <li class="breadcrumb-item"><a href="#" data-path="/mnt/nfs/media">Media Root</a></li>
                                    </ol>
                                </nav>
                                <div class="file-browser" id="es-browser"></div>
                                <div class="mt-3">
                                    <p>Selected: <span id="es-selected-path" class="text-primary">None</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5>Destination Path (Optional)</h5>
                            </div>
                            <div class="card-body">
                                <p class="text-muted">If not specified, the output file will be saved in the same directory as the original file.</p>
                                <div class="d-flex">
                                    <input type="text" class="form-control" id="destination-path" placeholder="Select destination path" readonly>
                                    <button id="browse-destination" class="btn btn-outline-secondary ms-2">Browse</button>
                                    <button id="clear-destination" class="btn btn-outline-danger ms-2">Clear</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 text-center">
                        <button id="process-movie" class="btn btn-primary btn-lg" disabled>
                            <i class="bi bi-play-fill"></i> Process Files
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- TV Show Mode Tab -->
            <div class="tab-pane fade" id="tv-content" role="tabpanel">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>Search Parameters</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="series-name" class="form-label">Series Name</label>
                                    <input type="text" class="form-control" id="series-name" placeholder="Enter series name">
                                </div>
                                <div class="mb-3">
                                    <label for="season-number" class="form-label">Season Number</label>
                                    <input type="number" class="form-control" id="season-number" placeholder="Enter season number">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Search Paths</label>
                                    <div id="search-paths" class="selected-files">
                                        <p class="text-muted">No paths selected</p>
                                    </div>
                                </div>
                                <button id="add-search-path" class="btn btn-outline-secondary">
                                    <i class="bi bi-folder-plus"></i> Add Search Path
                                </button>
                                <button id="search-files" class="btn btn-primary" disabled>
                                    <i class="bi bi-search"></i> Search Files
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>Matched Files</h5>
                            </div>
                            <div class="card-body">
                                <div id="matched-files" class="selected-files">
                                    <p class="text-muted">No matches found yet</p>
                                </div>
                                <div class="d-flex justify-content-between mt-3">
                                    <button id="select-all-matches" class="btn btn-outline-secondary" disabled>
                                        <i class="bi bi-check-all"></i> Select All
                                    </button>
                                    <button id="process-tv" class="btn btn-primary" disabled>
                                        <i class="bi bi-play-fill"></i> Process Selected
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5>Destination Path (Optional)</h5>
                            </div>
                            <div class="card-body">
                                <p class="text-muted">If not specified, the output files will be saved in the same directories as the original files.</p>
                                <div class="d-flex">
                                    <input type="text" class="form-control" id="tv-destination-path" placeholder="Select destination path" readonly>
                                    <button id="browse-tv-destination" class="btn btn-outline-secondary ms-2">Browse</button>
                                    <button id="clear-tv-destination" class="btn btn-outline-danger ms-2">Clear</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Jobs Tab -->
            <div class="tab-pane fade" id="jobs-content" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5>Processing Jobs</h5>
                    </div>
                    <div class="card-body">
                        <div id="jobs-container">
                            <p class="text-muted">Loading job history...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Path Selection Modal -->
    <div class="modal fade" id="pathModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Select Path</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <nav aria-label="breadcrumb" id="modal-breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="#" data-path="/mnt/nfs/media">Media Root</a></li>
                        </ol>
                    </nav>
                    <div class="file-browser" id="modal-browser"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="select-path-btn">Select</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global state
        const state = {
            mediaRoot: '/mnt/nfs/media',
            activeTab: 'movie',
            movieMode: {
                voPath: null,
                esPath: null,
                destinationPath: null
            },
            tvMode: {
                searchPaths: [],
                matches: [],
                selectedMatches: [],
                destinationPath: null
            },
            currentModal: {
                browser: null,
                currentPath: null,
                selectedPath: null,
                callback: null,
                selectingFolder: false
            },
            jobs: {}
        };

        // DOM Elements
        const elements = {
            // Navigation
            navMovie: document.getElementById('nav-movie'),
            navTv: document.getElementById('nav-tv'),
            navJobs: document.getElementById('nav-jobs'),
            
            // Content panels
            movieContent: document.getElementById('movie-content'),
            tvContent: document.getElementById('tv-content'),
            jobsContent: document.getElementById('jobs-content'),
            
            // Media root status
            mediaRootStatus: document.getElementById('media-root-status'),
            mediaRootPath: document.getElementById('media-root-path'),
            mediaRootStatusText: document.getElementById('media-root-status-text'),
            
            // Movie mode elements
            voBrowser: document.getElementById('vo-browser'),
            esBrowser: document.getElementById('es-browser'),
            voBreadcrumb: document.getElementById('vo-breadcrumb'),
            esBreadcrumb: document.getElementById('es-breadcrumb'),
            voSelectedPath: document.getElementById('vo-selected-path'),
            esSelectedPath: document.getElementById('es-selected-path'),
            destinationPath: document.getElementById('destination-path'),
            browseDestination: document.getElementById('browse-destination'),
            clearDestination: document.getElementById('clear-destination'),
            processMovie: document.getElementById('process-movie'),
            
            // TV mode elements
            seriesName: document.getElementById('series-name'),
            seasonNumber: document.getElementById('season-number'),
            searchPaths: document.getElementById('search-paths'),
            addSearchPath: document.getElementById('add-search-path'),
            searchFiles: document.getElementById('search-files'),
            matchedFiles: document.getElementById('matched-files'),
            selectAllMatches: document.getElementById('select-all-matches'),
            processTv: document.getElementById('process-tv'),
            tvDestinationPath: document.getElementById('tv-destination-path'),
            browseTvDestination: document.getElementById('browse-tv-destination'),
            clearTvDestination: document.getElementById('clear-tv-destination'),
            
            // Jobs elements
            jobsContainer: document.getElementById('jobs-container'),
            
            // Modal elements
            pathModal: document.getElementById('pathModal'),
            modalBrowser: document.getElementById('modal-browser'),
            modalBreadcrumb: document.getElementById('modal-breadcrumb'),
            selectPathBtn: document.getElementById('select-path-btn')
        };

        // Bootstrap modal instance
        let pathModal = null;

        // Initialize the application
        function init() {
            // Initialize Bootstrap modal
            pathModal = new bootstrap.Modal(elements.pathModal);
            
            // Set up event listeners
            setupEventListeners();
            
            // Load media root status
            loadMediaRootStatus();
            
            // Set active tab
            setActiveTab('movie');
            
            // Load file browsers
            loadFileBrowser(elements.voBrowser, elements.voBreadcrumb, state.mediaRoot);
            loadFileBrowser(elements.esBrowser, elements.esBreadcrumb, state.mediaRoot);
            
            // Load jobs
            loadJobs();
        }

        // Set up event listeners
        function setupEventListeners() {
            // Navigation
            elements.navMovie.addEventListener('click', () => setActiveTab('movie'));
            elements.navTv.addEventListener('click', () => setActiveTab('tv'));
            elements.navJobs.addEventListener('click', () => setActiveTab('jobs'));
            
            // Movie mode
            elements.browseDestination.addEventListener('click', () => openPathModal(selectDestinationPath, true));
            elements.clearDestination.addEventListener('click', clearDestinationPath);
            elements.processMovie.addEventListener('click', processMovie);
            
            // TV mode
            elements.addSearchPath.addEventListener('click', () => openPathModal(addSearchPath, true));
            elements.searchFiles.addEventListener('click', searchFiles);
            elements.selectAllMatches.addEventListener('click', selectAllMatches);
            elements.processTv.addEventListener('click', processTv);
            elements.browseTvDestination.addEventListener('click', () => openPathModal(selectTvDestinationPath, true));
            elements.clearTvDestination.addEventListener('click', clearTvDestinationPath);
            
            // Modal
            elements.selectPathBtn.addEventListener('click', selectPath);
        }

        // Set active tab
        function setActiveTab(tab) {
            // Update state
            state.activeTab = tab;
            
            // Update navigation
            elements.navMovie.classList.toggle('active', tab === 'movie');
            elements.navTv.classList.toggle('active', tab === 'tv');
            elements.navJobs.classList.toggle('active', tab === 'jobs');
            
            // Update content panels
            elements.movieContent.classList.toggle('show', tab === 'movie');
            elements.movieContent.classList.toggle('active', tab === 'movie');
            elements.tvContent.classList.toggle('show', tab === 'tv');
            elements.tvContent.classList.toggle('active', tab === 'tv');
            elements.jobsContent.classList.toggle('show', tab === 'jobs');
            elements.jobsContent.classList.toggle('active', tab === 'jobs');
            
            // Refresh content if needed
            if (tab === 'jobs') {
                loadJobs();
            }
        }

        // Load media root status
        function loadMediaRootStatus() {
            fetch('/api/media-root')
                .then(response => response.json())
                .then(data => {
                    state.mediaRoot = data.media_root;
                    elements.mediaRootPath.textContent = data.media_root;
                    
                    if (data.exists && data.writable) {
                        elements.mediaRootStatus.classList.remove('alert-info', 'alert-warning', 'alert-danger');
                        elements.mediaRootStatus.classList.add('alert-success');
                        elements.mediaRootStatusText.textContent = '(Ready)';
                    } else if (data.exists && !data.writable) {
                        elements.mediaRootStatus.classList.remove('alert-info', 'alert-success', 'alert-danger');
                        elements.mediaRootStatus.classList.add('alert-warning');
                        elements.mediaRootStatusText.textContent = '(Not writable)';
                    } else {
                        elements.mediaRootStatus.classList.remove('alert-info', 'alert-success', 'alert-warning');
                        elements.mediaRootStatus.classList.add('alert-danger');
                        elements.mediaRootStatusText.textContent = '(Not found)';
                    }
                })
                .catch(error => {
                    console.error('Error loading media root status:', error);
                    showToast('Error loading media root status', 'danger');
                });
        }

        // Load file browser
        function loadFileBrowser(browserElement, breadcrumbElement, path) {
            fetch(`/api/list-directories?path=${encodeURIComponent(path)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showToast(data.error, 'danger');
                        return;
                    }
                    
                    // Update browser content
                    browserElement.innerHTML = '';
                    
                    if (data.items.length === 0) {
                        const emptyMessage = document.createElement('div');
                        emptyMessage.className = 'p-3 text-muted';
                        emptyMessage.textContent = 'Empty directory';
                        browserElement.appendChild(emptyMessage);
                    } else {
                        data.items.forEach(item => {
                            const itemElement = document.createElement('div');
                            itemElement.className = 'file-item';
                            itemElement.dataset.path = item.path;
                            itemElement.dataset.type = item.type;
                            
                            const icon = document.createElement('i');
                            icon.className = item.type === 'directory' ? 'bi bi-folder' : 'bi bi-file-earmark-play';
                            
                            const nameSpan = document.createElement('span');
                            nameSpan.textContent = item.name;
                            
                            itemElement.appendChild(icon);
                            itemElement.appendChild(nameSpan);
                            
                            // Add click event
                            itemElement.addEventListener('click', () => {
                                if (item.type === 'directory') {
                                    // Navigate to directory
                                    loadFileBrowser(browserElement, breadcrumbElement, item.path);
                                    updateBreadcrumb(breadcrumbElement, item.path);
                                } else {
                                    // Select file
                                    selectFile(browserElement, itemElement);
                                    
                                    // Update selected path based on browser
                                    if (browserElement === elements.voBrowser) {
                                        state.movieMode.voPath = item.path;
                                        elements.voSelectedPath.textContent = item.path;
                                        updateProcessButtonState();
                                    } else if (browserElement === elements.esBrowser) {
                                        state.movieMode.esPath = item.path;
                                        elements.esSelectedPath.textContent = item.path;
                                        updateProcessButtonState();
                                    } else if (browserElement === elements.modalBrowser && !state.currentModal.selectingFolder) {
                                        state.currentModal.selectedPath = item.path;
                                    }
                                }
                            });
                            
                            browserElement.appendChild(itemElement);
                        });
                    }
                    
                    // Update breadcrumb
                    updateBreadcrumb(breadcrumbElement, data.current_path);
                    
                    // Update modal state if this is the modal browser
                    if (browserElement === elements.modalBrowser) {
                        state.currentModal.currentPath = data.current_path;
                    }
                })
                .catch(error => {
                    console.error('Error loading file browser:', error);
                    showToast('Error loading file browser', 'danger');
                });
        }

        // Update breadcrumb
        function updateBreadcrumb(breadcrumbElement, path) {
            const breadcrumb = breadcrumbElement.querySelector('ol');
            breadcrumb.innerHTML = '';
            
            // Add media root
            const rootItem = document.createElement('li');
            rootItem.className = 'breadcrumb-item';
            const rootLink = document.createElement('a');
            rootLink.href = '#';
            rootLink.textContent = 'Media Root';
            rootLink.dataset.path = state.mediaRoot;
            rootLink.addEventListener('click', (e) => {
                e.preventDefault();
                const browser = breadcrumbElement === elements.voBreadcrumb ? elements.voBrowser :
                                breadcrumbElement === elements.esBreadcrumb ? elements.esBrowser :
                                elements.modalBrowser;
                loadFileBrowser(browser, breadcrumbElement, state.mediaRoot);
            });
            rootItem.appendChild(rootLink);
            breadcrumb.appendChild(rootItem);
            
            // Skip if path is media root
            if (path === state.mediaRoot) {
                return;
            }
            
            // Split path into parts
            const relativePath = path.substring(state.mediaRoot.length + 1);
            const parts = relativePath.split('/');
            
            // Add each part
            let currentPath = state.mediaRoot;
            parts.forEach((part, index) => {
                currentPath += '/' + part;
                
                const item = document.createElement('li');
                item.className = 'breadcrumb-item';
                
                if (index === parts.length - 1) {
                    // Last part is active
                    item.classList.add('active');
                    item.textContent = part;
                } else {
                    // Add link for navigation
                    const link = document.createElement('a');
                    link.href = '#';
                    link.textContent = part;
                    link.dataset.path = currentPath;
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const browser = breadcrumbElement === elements.voBreadcrumb ? elements.voBrowser :
                                        breadcrumbElement === elements.esBreadcrumb ? elements.esBrowser :
                                        elements.modalBrowser;
                        loadFileBrowser(browser, breadcrumbElement, currentPath);
                    });
                    item.appendChild(link);
                }
                
                breadcrumb.appendChild(item);
            });
        }

        // Select file
        function selectFile(browserElement, itemElement) {
            // Remove selection from all items
            const items = browserElement.querySelectorAll('.file-item');
            items.forEach(item => item.classList.remove('selected'));
            
            // Add selection to clicked item
            itemElement.classList.add('selected');
        }

        // Update process button state
        function updateProcessButtonState() {
            elements.processMovie.disabled = !(state.movieMode.voPath && state.movieMode.esPath);
            elements.searchFiles.disabled = state.tvMode.searchPaths.length === 0;
            elements.processTv.disabled = state.tvMode.selectedMatches.length === 0;
        }

        // Open path selection modal
        function openPathModal(callback, selectFolder = false) {
            state.currentModal.callback = callback;
            state.currentModal.selectedPath = null;
            state.currentModal.selectingFolder = selectFolder;
            
            // Load modal browser
            loadFileBrowser(elements.modalBrowser, elements.modalBreadcrumb, state.mediaRoot);
            
            // Show modal
            pathModal.show();
        }

        // Select path from modal
        function selectPath() {
            if (state.currentModal.selectingFolder) {
                // When selecting a folder, use the current path
                if (state.currentModal.currentPath) {
                    state.currentModal.callback(state.currentModal.currentPath);
                    pathModal.hide();
                } else {
                    showToast('Please navigate to a folder', 'warning');
                }
            } else {
                // When selecting a file, use the selected path
                if (state.currentModal.selectedPath) {
                    state.currentModal.callback(state.currentModal.selectedPath);
                    pathModal.hide();
                } else {
                    showToast('Please select a file', 'warning');
                }
            }
        }

        // Select destination path
        function selectDestinationPath(path) {
            state.movieMode.destinationPath = path;
            elements.destinationPath.value = path;
        }

        // Clear destination path
        function clearDestinationPath() {
            state.movieMode.destinationPath = null;
            elements.destinationPath.value = '';
        }

        // Add search path
        function addSearchPath(path) {
            if (!state.tvMode.searchPaths.includes(path)) {
                state.tvMode.searchPaths.push(path);
                updateSearchPathsDisplay();
                updateProcessButtonState();
            }
        }

        // Update search paths display
        function updateSearchPathsDisplay() {
            if (state.tvMode.searchPaths.length === 0) {
                elements.searchPaths.innerHTML = '<p class="text-muted">No paths selected</p>';
                return;
            }
            
            elements.searchPaths.innerHTML = '';
            state.tvMode.searchPaths.forEach((path, index) => {
                const pathElement = document.createElement('div');
                pathElement.className = 'selected-pair d-flex justify-content-between align-items-center';
                
                const pathText = document.createElement('span');
                pathText.textContent = path;
                
                const removeButton = document.createElement('button');
                removeButton.className = 'btn btn-sm btn-outline-danger';
                removeButton.innerHTML = '<i class="bi bi-x"></i>';
                removeButton.addEventListener('click', () => {
                    state.tvMode.searchPaths.splice(index, 1);
                    updateSearchPathsDisplay();
                    updateProcessButtonState();
                });
                
                pathElement.appendChild(pathText);
                pathElement.appendChild(removeButton);
                elements.searchPaths.appendChild(pathElement);
            });
        }

        // Search for files
        function searchFiles() {
            if (state.tvMode.searchPaths.length === 0) {
                showToast('Please add at least one search path', 'warning');
                return;
            }
            
            // Show loading state
            elements.matchedFiles.innerHTML = '<p class="text-center"><i class="bi bi-hourglass-split"></i> Searching...</p>';
            elements.searchFiles.disabled = true;
            
            // Prepare request data
            const data = {
                paths: state.tvMode.searchPaths,
                series: elements.seriesName.value || null,
                season: elements.seasonNumber.value || null
            };
            
            // Send request
            fetch('/api/search-files', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showToast(data.error, 'danger');
                        elements.matchedFiles.innerHTML = '<p class="text-muted">No matches found</p>';
                        return;
                    }
                    
                    // Update state
                    state.tvMode.matches = data.matches;
                    state.tvMode.selectedMatches = [];
                    
                    // Update display
                    updateMatchedFilesDisplay();
                    
                    // Enable search button
                    elements.searchFiles.disabled = false;
                })
                .catch(error => {
                    console.error('Error searching for files:', error);
                    showToast('Error searching for files', 'danger');
                    elements.searchFiles.disabled = false;
                    elements.matchedFiles.innerHTML = '<p class="text-muted">No matches found</p>';
                });
        }

        // Update matched files display
        function updateMatchedFilesDisplay() {
            if (state.tvMode.matches.length === 0) {
                elements.matchedFiles.innerHTML = '<p class="text-muted">No matches found</p>';
                elements.selectAllMatches.disabled = true;
                return;
            }
            
            elements.matchedFiles.innerHTML = '';
            state.tvMode.matches.forEach((match, index) => {
                const matchElement = document.createElement('div');
                matchElement.className = 'selected-pair';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'form-check-input me-2';
                checkbox.checked = state.tvMode.selectedMatches.includes(index);
                checkbox.addEventListener('change', () => {
                    if (checkbox.checked) {
                        if (!state.tvMode.selectedMatches.includes(index)) {
                            state.tvMode.selectedMatches.push(index);
                        }
                    } else {
                        const selectedIndex = state.tvMode.selectedMatches.indexOf(index);
                        if (selectedIndex !== -1) {
                            state.tvMode.selectedMatches.splice(selectedIndex, 1);
                        }
                    }
                    updateProcessButtonState();
                });
                
                const label = document.createElement('label');
                label.className = 'form-check-label';
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(match.key));
                
                const details = document.createElement('div');
                details.className = 'mt-1 ms-4 small text-muted';
                details.innerHTML = `
                    <div>VO: ${match.vo_file}</div>
                    <div>ES: ${match.es_file}</div>
                `;
                
                matchElement.appendChild(label);
                matchElement.appendChild(details);
                elements.matchedFiles.appendChild(matchElement);
            });
            
            elements.selectAllMatches.disabled = false;
        }

        // Select all matches
        function selectAllMatches() {
            state.tvMode.selectedMatches = [];
            for (let i = 0; i < state.tvMode.matches.length; i++) {
                state.tvMode.selectedMatches.push(i);
            }
            updateMatchedFilesDisplay();
            updateProcessButtonState();
        }

        // Select TV destination path
        function selectTvDestinationPath(path) {
            state.tvMode.destinationPath = path;
            elements.tvDestinationPath.value = path;
        }

        // Clear TV destination path
        function clearTvDestinationPath() {
            state.tvMode.destinationPath = null;
            elements.tvDestinationPath.value = '';
        }

        // Process movie
        function processMovie() {
            if (!state.movieMode.voPath || !state.movieMode.esPath) {
                showToast('Please select both VO and ES files', 'warning');
                return;
            }
            
            // Disable button
            elements.processMovie.disabled = true;
            
            // Prepare request data
            const data = {
                mode: 'movie',
                file_pairs: [
                    {
                        vo_file: state.movieMode.voPath,
                        es_file: state.movieMode.esPath
                    }
                ],
                destination_path: state.movieMode.destinationPath
            };
            
            // Send request
            fetch('/api/process-files', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showToast(data.error, 'danger');
                        elements.processMovie.disabled = false;
                        return;
                    }
                    
                    // Show success message
                    showToast(`Processing started: ${data.message}`, 'success');
                    
                    // Switch to jobs tab
                    setActiveTab('jobs');
                    
                    // Poll for job status
                    pollJobStatus(data.job_id);
                })
                .catch(error => {
                    console.error('Error processing movie:', error);
                    showToast('Error processing movie', 'danger');
                    elements.processMovie.disabled = false;
                });
        }

        // Process TV
        function processTv() {
            if (state.tvMode.selectedMatches.length === 0) {
                showToast('Please select at least one file pair', 'warning');
                return;
            }
            
            // Disable button
            elements.processTv.disabled = true;
            
            // Prepare file pairs
            const filePairs = state.tvMode.selectedMatches.map(index => {
                const match = state.tvMode.matches[index];
                return {
                    vo_file: match.vo_file,
                    es_file: match.es_file
                };
            });
            
            // Prepare request data
            const data = {
                mode: 'tv',
                file_pairs: filePairs,
                destination_path: state.tvMode.destinationPath
            };
            
            // Send request
            fetch('/api/process-files', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showToast(data.error, 'danger');
                        elements.processTv.disabled = false;
                        return;
                    }
                    
                    // Show success message
                    showToast(`Processing started: ${data.message}`, 'success');
                    
                    // Switch to jobs tab
                    setActiveTab('jobs');
                    
                    // Poll for job status
                    pollJobStatus(data.job_id);
                })
                .catch(error => {
                    console.error('Error processing TV show:', error);
                    showToast('Error processing TV show', 'danger');
                    elements.processTv.disabled = false;
                });
        }

        // Load jobs
        function loadJobs() {
            fetch('/api/active-jobs')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showToast(data.error, 'danger');
                        return;
                    }
                    
                    // Update state
                    state.jobs = {};
                    data.jobs.forEach(job => {
                        state.jobs[job.job_id] = job;
                    });
                    
                    // Update display
                    updateJobsDisplay();
                })
                .catch(error => {
                    console.error('Error loading jobs:', error);
                    showToast('Error loading jobs', 'danger');
                });
        }

        // Update jobs display
        function updateJobsDisplay() {
            const jobs = Object.values(state.jobs);
            
            if (jobs.length === 0) {
                elements.jobsContainer.innerHTML = '<p class="text-muted">No jobs found</p>';
                return;
            }
            
            elements.jobsContainer.innerHTML = '';
            jobs.forEach(job => {
                const jobElement = document.createElement('div');
                jobElement.className = 'card job-card';
                
                // Determine card color based on status
                let statusClass = 'bg-secondary';
                if (job.status === 'completed') {
                    statusClass = 'bg-success';
                } else if (job.status === 'failed') {
                    statusClass = 'bg-danger';
                } else if (job.status === 'processing') {
                    statusClass = 'bg-primary';
                }
                
                // Format timestamps
                const startTime = new Date(job.start_time * 1000).toLocaleString();
                const endTime = job.end_time ? new Date(job.end_time * 1000).toLocaleString() : 'N/A';
                
                // Create card header
                const header = document.createElement('div');
                header.className = `card-header text-white ${statusClass}`;
                header.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Job ${job.job_id}</h5>
                        <span class="badge bg-light text-dark">${job.mode.toUpperCase()}</span>
                    </div>
                `;
                
                // Create card body
                const body = document.createElement('div');
                body.className = 'card-body';
                
                // Add progress bar if job is processing
                if (job.status === 'processing') {
                    body.innerHTML += `
                        <div class="progress mb-3">
                            <div class="progress-bar" role="progressbar" style="width: ${job.progress}%"
                                aria-valuenow="${job.progress}" aria-valuemin="0" aria-valuemax="100">
                                ${Math.round(job.progress)}%
                            </div>
                        </div>
                    `;
                }
                
                // Add job details
                body.innerHTML += `
                    <div class="row mb-2">
                        <div class="col-md-3"><strong>Status:</strong></div>
                        <div class="col-md-9">${job.status}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-3"><strong>Files:</strong></div>
                        <div class="col-md-9">${job.processed} / ${job.file_count}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-3"><strong>Started:</strong></div>
                        <div class="col-md-9">${startTime}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-3"><strong>Completed:</strong></div>
                        <div class="col-md-9">${endTime}</div>
                    </div>
                `;
                
                // Add error message if job failed
                if (job.error) {
                    body.innerHTML += `
                        <div class="alert alert-danger mt-3">
                            <strong>Error:</strong> ${job.error}
                        </div>
                    `;
                }
                
                // Add results if available
                if (job.results && job.results.length > 0) {
                    const resultsContainer = document.createElement('div');
                    resultsContainer.className = 'mt-3';
                    resultsContainer.innerHTML = '<h6>Results:</h6>';
                    
                    job.results.forEach(result => {
                        const resultElement = document.createElement('div');
                        resultElement.className = `job-result ${result.success ? 'success' : 'failure'}`;
                        
                        resultElement.innerHTML = `
                            <div><strong>VO:</strong> ${result.vo_file}</div>
                            <div><strong>ES:</strong> ${result.es_file}</div>
                        `;
                        
                        if (result.output_file) {
                            resultElement.innerHTML += `<div><strong>Output:</strong> ${result.output_file}</div>`;
                        }
                        
                        if (result.message) {
                            resultElement.innerHTML += `<div><strong>Status:</strong> ${result.message}</div>`;
                        }
                        
                        resultsContainer.appendChild(resultElement);
                    });
                    
                    body.appendChild(resultsContainer);
                }
                
                // Assemble card
                jobElement.appendChild(header);
                jobElement.appendChild(body);
                elements.jobsContainer.appendChild(jobElement);
            });
        }

        // Poll job status
        function pollJobStatus(jobId, interval = 2000) {
            const checkStatus = () => {
                fetch(`/api/job-status/${jobId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            console.error('Error polling job status:', data.error);
                            return;
                        }
                        
                        // Update job in state
                        state.jobs[jobId] = data;
                        
                        // Update display if jobs tab is active
                        if (state.activeTab === 'jobs') {
                            updateJobsDisplay();
                        }
                        
                        // Continue polling if job is still processing
                        if (data.status === 'processing') {
                            setTimeout(checkStatus, interval);
                        } else {
                            // Show notification when job completes
                            const status = data.status === 'completed' ? 'success' : 'danger';
                            const message = data.status === 'completed' ? 
                                'Job completed successfully' : 
                                `Job failed: ${data.error || 'Unknown error'}`;
                            showToast(message, status);
                            
                            // Re-enable process buttons
                            elements.processMovie.disabled = false;
                            elements.processTv.disabled = false;
                        }
                    })
                    .catch(error => {
                        console.error('Error polling job status:', error);
                    });
            };
            
            // Start polling
            setTimeout(checkStatus, interval);
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toast-container');
            
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type} border-0 mb-2`;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');
            
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            
            const bsToast = new bootstrap.Toast(toast, {
                autohide: true,
                delay: 5000
            });
            
            bsToast.show();
            
            // Remove toast from DOM after it's hidden
            toast.addEventListener('hidden.bs.toast', () => {
                toast.remove();
            });
        }

        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
